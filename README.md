# æµå¼æ¥å£å¹¶å‘æµ‹è¯•å·¥å…·

**é€šç”¨æµå¼æ¥å£æµ‹è¯•å·¥å…·** - å¯ä»¥æµ‹è¯•ä»»ä½•æ”¯æŒHTTPæµå¼å“åº”çš„APIï¼ˆå¦‚ChatGPTã€Claudeã€Difyç­‰ï¼‰ï¼Œç²¾ç¡®æµ‹é‡é¦–tokenæ—¶é—´(TTFT)å’Œæ€»ä½“æ€§èƒ½ã€‚

> ğŸ“– **é€šç”¨æ€§è¯´æ˜**: æŸ¥çœ‹ [UNIVERSAL_STREAMING_API.md](UNIVERSAL_STREAMING_API.md) äº†è§£å¦‚ä½•æµ‹è¯•ä»»ä½•æµå¼æ¥å£

## æ ¸å¿ƒç‰¹æ€§

âœ… **å›ºå®šå¹¶å‘æ§åˆ¶** - ä¿æŒæ’å®šå¹¶å‘æ•°ï¼Œä¸€ä¸ªè¯·æ±‚å®Œæˆåç«‹å³å¼€å¯ä¸‹ä¸€ä¸ª  
âœ… **é¦–Tokenæ—¶é—´æµ‹è¯•** - ç²¾ç¡®æµ‹é‡æ¯ä¸ªè¯·æ±‚çš„TTFT (Time To First Token)  
âœ… **å®Œæ•´æ€§èƒ½æŒ‡æ ‡** - ç»Ÿè®¡P50/P90/P95/P99ç­‰å…³é”®æŒ‡æ ‡  
âœ… **çµæ´»é…ç½®** - æ”¯æŒé…ç½®æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°  
âœ… **CSVæ•°æ®æºæ”¯æŒ** - ä»CSVæ–‡ä»¶è¯»å–æµ‹è¯•æ•°æ®ï¼Œæ¯æ¬¡è¯·æ±‚ä½¿ç”¨ä¸åŒå†…å®¹  
âœ… **è¯¦ç»†æŠ¥å‘Š** - å®æ—¶è¿›åº¦æ˜¾ç¤ºå’Œå®Œæ•´JSONç»“æœå¯¼å‡º  

## å®‰è£…ä¾èµ–

### ä½¿ç”¨ uvï¼ˆæ¨èï¼‰

æœ¬é¡¹ç›®ä½¿ç”¨ [uv](https://github.com/astral-sh/uv) è¿›è¡Œä¾èµ–ç®¡ç†ï¼Œé€Ÿåº¦æ›´å¿«ï¼š

```bash
# å®‰è£… uvï¼ˆå¦‚æœè¿˜æ²¡æœ‰å®‰è£…ï¼‰
curl -LsSf https://astral.sh/uv/install.sh | sh

# åŒæ­¥ä¾èµ–ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–ï¼‰
uv sync

# è¿è¡Œè„šæœ¬
uv run python stream_test_enhanced.py -c config.json
```

ğŸ“– **è¯¦ç»†ä½¿ç”¨è¯´æ˜**ï¼šæŸ¥çœ‹ [UV_USAGE.md](UV_USAGE.md) äº†è§£å®Œæ•´çš„ uv å‘½ä»¤å’Œæœ€ä½³å®è·µã€‚

### ä½¿ç”¨ pipï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰

```bash
pip install aiohttp
```

## é¡¹ç›®ç»“æ„

```
ai_benchmark/
â”œâ”€â”€ src/          # ä»£ç éƒ¨åˆ†
â”œâ”€â”€ configs/      # é…ç½®éƒ¨åˆ†
â”œâ”€â”€ data/         # æ•°æ®å¤‡ä»½
â””â”€â”€ docs/         # æ–‡æ¡£
```

ğŸ“– **è¯¦ç»†ç»“æ„è¯´æ˜**: æŸ¥çœ‹ [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md)

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼1: ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

1. ç¼–è¾‘ `configs/config.json` é…ç½®ä½ çš„æ¥å£ä¿¡æ¯ï¼š

```json
{
  "url": "https://api.openai.com/v1/chat/completions",
  "method": "POST",
  "headers": {
    "Content-Type": "application/json",
    "Authorization": "Bearer sk-your-api-key"
  },
  "body": {
    "model": "gpt-3.5-turbo",
    "messages": [
      {"role": "user", "content": "å†™ä¸€ä¸ªå…³äºAIçš„çŸ­æ–‡"}
    ],
    "stream": true,
    "max_tokens": 500
  },
  "timeout": 300,
  "concurrency": 10,
  "total_requests": 100
}
```

2. è¿è¡Œæµ‹è¯•ï¼š

```bash
uv run python src/stream_test_enhanced.py -c configs/config.json
```

### æ–¹å¼2: ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°

```bash
python stream_test_enhanced.py -u https://api.example.com/stream -n 50 -p 10
```

å‚æ•°è¯´æ˜ï¼š
- `-c, --config`: é…ç½®æ–‡ä»¶è·¯å¾„
- `-u, --url`: æ¥å£URL
- `-n, --requests`: æ€»è¯·æ±‚æ•°ï¼ˆé»˜è®¤100ï¼‰
- `-p, --concurrency`: å¹¶å‘æ•°ï¼ˆé»˜è®¤10ï¼‰

### æ–¹å¼3: ç›´æ¥ä¿®æ”¹ä»£ç 

ç¼–è¾‘ `stream_concurrent_test.py` ä¸­çš„é…ç½®åŒºåŸŸï¼š

```python
config = RequestConfig(
    url="https://your-api.com/v1/stream",
    method="POST",
    headers={
        "Content-Type": "application/json",
        "Authorization": "Bearer your-token",
    },
    body={
        "prompt": "ä½ çš„æç¤ºè¯",
        "stream": True,
        "max_tokens": 100
    }
)

CONCURRENCY = 10        # å¹¶å‘æ•°
TOTAL_REQUESTS = 50     # æ€»è¯·æ±‚æ•°
```

è¿è¡Œï¼š

```bash
python stream_concurrent_test.py
```

## é…ç½®è¯´æ˜

### RequestConfig å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| url | string | æµå¼æ¥å£URL | `https://api.openai.com/v1/chat/completions` |
| method | string | HTTPæ–¹æ³• | `POST` (é»˜è®¤) |
| headers | dict | è¯·æ±‚å¤´ | `{"Authorization": "Bearer xxx"}` |
| body | dict | è¯·æ±‚ä½“ | `{"stream": true, "messages": [...]}` |
| timeout | int | è¶…æ—¶æ—¶é—´(ç§’) | `300` (é»˜è®¤) |

### æµ‹è¯•å‚æ•°

- **concurrency**: å¹¶å‘æ•°ï¼ˆåŒæ—¶è¿›è¡Œçš„è¯·æ±‚æ•°é‡ï¼‰
- **total_requests**: æ€»è¯·æ±‚æ•°ï¼ˆæµ‹è¯•çš„æ€»è¯·æ±‚æ¬¡æ•°ï¼‰

### CSVæ•°æ®æºé…ç½®ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰

æ”¯æŒä»CSVæ–‡ä»¶è¯»å–æµ‹è¯•æ•°æ®ï¼Œæ¯æ¬¡è¯·æ±‚è‡ªåŠ¨ä½¿ç”¨CSVä¸­çš„ä¸€è¡Œå†…å®¹ã€‚

#### 1. åˆ›å»ºCSVæ–‡ä»¶

åˆ›å»º `test_data.csv` æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

```csv
content,topic,category
å†™ä¸€ä¸ªå…³äºäººå·¥æ™ºèƒ½çš„çŸ­æ–‡,AI,ç§‘æŠ€
ä»‹ç»Pythonç¼–ç¨‹è¯­è¨€çš„ç‰¹ç‚¹å’Œåº”ç”¨,ç¼–ç¨‹,æŠ€æœ¯
åˆ†ææœºå™¨å­¦ä¹ ç®—æ³•çš„ä¼˜ç¼ºç‚¹,ML,ç§‘æŠ€
è§£é‡Šæ·±åº¦å­¦ä¹ çš„åŸç†,æ·±åº¦å­¦ä¹ ,ç§‘æŠ€
è®¨è®ºè‡ªç„¶è¯­è¨€å¤„ç†çš„å‘å±•è¶‹åŠ¿,NLP,ç§‘æŠ€
```

#### 2. é…ç½®æ•°æ®æº

åœ¨ `config.json` ä¸­æ·»åŠ  `data_source` é…ç½®ï¼š

```json
{
  "url": "https://api.example.com/v1/chat/completions",
  "method": "POST",
  "headers": {
    "Content-Type": "application/json",
    "Authorization": "Bearer sk-xxxxxxxxxxxxxxxx"
  },
  "data_source": {
    "type": "csv",
    "file": "test_data.csv",
    "column": "content",
    "encoding": "utf-8"
  },
  "body": {
    "model": "gpt-3.5-turbo",
    "messages": [
      {
        "role": "user",
        "content": "{{content}}"
      }
    ],
    "stream": true,
    "max_tokens": 500
  },
  "timeout": 300,
  "concurrency": 10,
  "total_requests": 100
}
```

#### 3. å ä½ç¬¦è¯´æ˜

- ä½¿ç”¨ `{{column_name}}` æ ¼å¼åœ¨ `body` ä¸­æŒ‡å®šå ä½ç¬¦
- å ä½ç¬¦ä¼šè¢«CSVå¯¹åº”åˆ—çš„å€¼æ›¿æ¢
- æ”¯æŒå¤šä¸ªå ä½ç¬¦ï¼Œä¾‹å¦‚ï¼š`"{{topic}} - {{content}}"`
- å¦‚æœè¯·æ±‚æ•°å¤§äºCSVè¡Œæ•°ï¼Œä¼šè‡ªåŠ¨å¾ªç¯ä½¿ç”¨æ•°æ®

#### 4. æ•°æ®æºé…ç½®å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| type | string | æ•°æ®æºç±»å‹ï¼Œç›®å‰æ”¯æŒ `csv` | æ˜¯ |
| file | string | CSVæ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„ç›¸å¯¹äºé…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼‰ | æ˜¯ |
| column | string | æŒ‡å®šä½¿ç”¨çš„åˆ—åï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æ‰€æœ‰åˆ—ï¼‰ | å¦ |
| encoding | string | æ–‡ä»¶ç¼–ç ï¼ˆé»˜è®¤ `utf-8`ï¼‰ | å¦ |

#### 5. ç¤ºä¾‹

æŸ¥çœ‹ `config_csv_example.json` å’Œ `test_data.csv` è·å–å®Œæ•´ç¤ºä¾‹ã€‚

## è¾“å‡ºæŠ¥å‘Š

### å®æ—¶è¾“å‡º

```
[001] é¦–token: 0.234s
[001] å®Œæˆ: 2.456s | 45 chunks | 18.32 chunks/s | 12.34 KB
è¿›åº¦: 1/100 | å·²ç”¨æ—¶: 2.5s
```

### æœ€ç»ˆæŠ¥å‘Š

```
============================================================
æµ‹è¯•æŠ¥å‘Š
============================================================

ã€æ€»ä½“ç»Ÿè®¡ã€‘
  æ€»è¯·æ±‚æ•°:    100
  æˆåŠŸ:        98 (98.0%)
  å¤±è´¥:        2 (2.0%)
  æ€»è€—æ—¶:      25.67s
  ååé‡:      3.90 req/s

ã€é¦–Tokenæ—¶é—´ (TTFT)ã€‘
  æœ€å°å€¼:      0.123s
  æœ€å¤§å€¼:      1.234s
  å¹³å‡å€¼:      0.456s
  ä¸­ä½æ•°:      0.432s
  æ ‡å‡†å·®:      0.089s
  P50:         0.432s
  P90:         0.678s
  P95:         0.789s
  P99:         1.012s

ã€æ€»è€—æ—¶ã€‘
  æœ€å°å€¼:      1.234s
  æœ€å¤§å€¼:      5.678s
  å¹³å‡å€¼:      2.345s
  ä¸­ä½æ•°:      2.234s
  P95:         3.456s
  P99:         4.567s

ã€ç”Ÿæˆé€Ÿç‡ã€‘
  å¹³å‡å€¼:      18.45 chunks/s
  ä¸­ä½æ•°:      17.89 chunks/s
  æœ€å¤§å€¼:      25.67 chunks/s
```

### JSONç»“æœæ–‡ä»¶

æµ‹è¯•å®Œæˆåä¼šç”Ÿæˆ `test_results.json`ï¼ŒåŒ…å«æ¯ä¸ªè¯·æ±‚çš„è¯¦ç»†æŒ‡æ ‡ï¼š

```json
{
  "config": {
    "url": "https://api.example.com/stream",
    "concurrency": 10,
    "total_requests": 100,
    "timestamp": "2024-01-15T10:30:00"
  },
  "summary": {
    "success_count": 98,
    "failed_count": 2
  },
  "metrics": [
    {
      "request_id": 1,
      "ttft": 0.234,
      "total_time": 2.456,
      "total_tokens": 45,
      "tokens_per_second": 18.32,
      "error": null
    }
  ]
}
```

## å…³é”®æŒ‡æ ‡è¯´æ˜

### TTFT (Time To First Token)
- **å®šä¹‰**: ä»è¯·æ±‚å‘é€åˆ°æ”¶åˆ°ç¬¬ä¸€ä¸ªå“åº”æ•°æ®å—çš„æ—¶é—´
- **é‡è¦æ€§**: è¡¡é‡APIçš„å“åº”é€Ÿåº¦ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
- **ä¼˜åŒ–ç›®æ ‡**: è¶Šä½è¶Šå¥½ï¼Œé€šå¸¸åº” < 1ç§’

### æ€»è€—æ—¶
- **å®šä¹‰**: è¯·æ±‚ä»å¼€å§‹åˆ°å®Œå…¨ç»“æŸçš„æ—¶é—´
- **åŒ…å«**: ç½‘ç»œå»¶è¿Ÿ + é¦–tokenæ—¶é—´ + æµå¼ç”Ÿæˆæ—¶é—´

### ç”Ÿæˆé€Ÿç‡ (Tokens/Second)
- **å®šä¹‰**: æ¯ç§’ç”Ÿæˆçš„tokenæ•°é‡
- **ç”¨é€”**: è¯„ä¼°æµå¼è¾“å‡ºçš„é€Ÿåº¦

### Percentile (ç™¾åˆ†ä½æ•°)
- **P50**: ä¸­ä½æ•°ï¼Œ50%çš„è¯·æ±‚ä¼˜äºæ­¤å€¼
- **P95**: 95%çš„è¯·æ±‚ä¼˜äºæ­¤å€¼
- **P99**: 99%çš„è¯·æ±‚ä¼˜äºæ­¤å€¼
- **ç”¨é€”**: è¯†åˆ«å¼‚å¸¸å€¼å’Œæ€§èƒ½ç“¶é¢ˆ

## å¹¶å‘æ§åˆ¶åŸç†

è„šæœ¬ä½¿ç”¨**ä¿¡å·é‡(Semaphore)**å®ç°å›ºå®šå¹¶å‘ï¼š

```
å¹¶å‘æ•° = 10

[è¯·æ±‚1] [è¯·æ±‚2] [è¯·æ±‚3] ... [è¯·æ±‚10]  â† åŒæ—¶è¿›è¡Œ
   â†“ å®Œæˆ
[è¯·æ±‚11] å¼€å§‹                          â† ç«‹å³è¡¥å……
```

ç‰¹ç‚¹ï¼š
- âœ… å§‹ç»ˆä¿æŒ10ä¸ªå¹¶å‘
- âœ… æŸä¸ªè¯·æ±‚å®Œå…¨ç»“æŸåæ‰å¼€å¯æ–°è¯·æ±‚
- âœ… ä¸ä¼šå‡ºç°å¹¶å‘æ•°æ³¢åŠ¨

## ä½¿ç”¨åœºæ™¯

### 1. å‹åŠ›æµ‹è¯•
è¯„ä¼°APIåœ¨é«˜å¹¶å‘ä¸‹çš„è¡¨ç°ï¼š
```bash
python stream_test_enhanced.py -c config.json
# è®¾ç½®: concurrency=50, total_requests=500
```

### 2. æ€§èƒ½åŸºå‡†æµ‹è¯•
å¯¹æ¯”ä¸åŒæ¨¡å‹æˆ–é…ç½®çš„æ€§èƒ½ï¼š
```bash
# æµ‹è¯•æ¨¡å‹A
python stream_test_enhanced.py -c config_model_a.json

# æµ‹è¯•æ¨¡å‹B
python stream_test_enhanced.py -c config_model_b.json
```

### 3. æŒç»­ç›‘æ§
å®šæœŸæµ‹è¯•APIæ€§èƒ½å˜åŒ–ï¼š
```bash
# æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
*/60 * * * * /usr/bin/python3 /path/to/stream_test_enhanced.py -c config.json
```

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æµ‹è¯•æœ¬åœ°APIï¼Ÿ
A: ä¿®æ”¹URLä¸ºæœ¬åœ°åœ°å€ï¼š
```json
{
  "url": "http://localhost:8000/v1/stream",
  ...
}
```

### Q: å¦‚ä½•å¤„ç†è®¤è¯ï¼Ÿ
A: åœ¨headersä¸­æ·»åŠ è®¤è¯ä¿¡æ¯ï¼š
```json
{
  "headers": {
    "Authorization": "Bearer your-token",
    "X-API-Key": "your-api-key"
  }
}
```

### Q: è¶…æ—¶å¦‚ä½•å¤„ç†ï¼Ÿ
A: è°ƒæ•´timeoutå‚æ•°ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼š
```json
{
  "timeout": 600  // 10åˆ†é’Ÿ
}
```

### Q: å¦‚ä½•æµ‹è¯•éæµå¼æ¥å£ï¼Ÿ
A: æ­¤å·¥å…·ä¸“ä¸ºæµå¼æ¥å£è®¾è®¡ï¼Œéæµå¼æ¥å£å»ºè®®ä½¿ç”¨å…¶ä»–å·¥å…·ï¼ˆå¦‚Apache Benchã€wrkï¼‰

### Q: Tokenè®¡æ•°ä¸å‡†ç¡®ï¼Ÿ
A: è„šæœ¬æŒ‰chunkæ•°é‡è®¡æ•°ï¼Œå¦‚éœ€ç²¾ç¡®tokenæ•°ï¼Œéœ€æ ¹æ®å…·ä½“APIåè®®è§£æå“åº”å†…å®¹

## æ–‡ä»¶è¯´æ˜

- `stream_concurrent_test.py` - åŸºç¡€ç‰ˆæœ¬ï¼ˆç›´æ¥ä¿®æ”¹ä»£ç é…ç½®ï¼‰
- `stream_test_enhanced.py` - å¢å¼ºç‰ˆæœ¬ï¼ˆæ”¯æŒé…ç½®æ–‡ä»¶å’Œå‘½ä»¤è¡Œï¼‰
- `config.json` - é…ç½®æ–‡ä»¶ç¤ºä¾‹
- `test_results.json` - æµ‹è¯•ç»“æœè¾“å‡ºï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰

## æ³¨æ„äº‹é¡¹

1. âš ï¸ **APIé™æµ**: æ³¨æ„ç›®æ ‡APIçš„é€Ÿç‡é™åˆ¶ï¼Œé¿å…è¢«å°ç¦
2. âš ï¸ **æˆæœ¬æ§åˆ¶**: å¤§é‡è¯·æ±‚å¯èƒ½äº§ç”Ÿè´¹ç”¨
3. âš ï¸ **ç½‘ç»œå¸¦å®½**: é«˜å¹¶å‘æµ‹è¯•éœ€è¦è¶³å¤Ÿçš„ç½‘ç»œå¸¦å®½
4. âš ï¸ **èµ„æºé™åˆ¶**: æ³¨æ„æœ¬åœ°ç³»ç»Ÿçš„æ–‡ä»¶æè¿°ç¬¦é™åˆ¶

## License

MIT License